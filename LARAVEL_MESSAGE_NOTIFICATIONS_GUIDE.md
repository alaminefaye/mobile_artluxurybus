# üîî Guide d'Impl√©mentation : Notifications Push pour Messages (Laravel)

## ‚ö†Ô∏è PROBL√àME IDENTIFI√â

Les notifications de type "notification" ne sont **PAS envoy√©es automatiquement** √† tous les utilisateurs car la logique d'envoi n'est **pas impl√©ment√©e c√¥t√© serveur Laravel**.

L'application Flutter est **correctement configur√©e** pour recevoir les notifications, mais le serveur Laravel ne les envoie pas automatiquement lors de la cr√©ation d'un message.

---

## üìã Ce qui doit √™tre impl√©ment√© c√¥t√© Laravel

### 1. **√âv√©nement `MessageCreated`**

Cr√©er le fichier : `app/Events/MessageCreated.php`

```php
<?php

namespace App\Events;

use App\Models\Message;
use Illuminate\Broadcasting\InteractsWithSockets;
use Illuminate\Foundation\Events\Dispatchable;
use Illuminate\Queue\SerializesModels;

class MessageCreated
{
    use Dispatchable, InteractsWithSockets, SerializesModels;

    public $message;

    /**
     * Create a new event instance.
     */
    public function __construct(Message $message)
    {
        $this->message = $message;
    }
}
```

---

### 2. **Listener `SendMessageNotification`**

Cr√©er le fichier : `app/Listeners/SendMessageNotification.php`

```php
<?php

namespace App\Listeners;

use App\Events\MessageCreated;
use App\Services\NotificationService;
use Illuminate\Support\Facades\Log;

class SendMessageNotification
{
    protected $notificationService;

    /**
     * Create the event listener.
     */
    public function __construct(NotificationService $notificationService)
    {
        $this->notificationService = $notificationService;
    }

    /**
     * Handle the event.
     */
    public function handle(MessageCreated $event): void
    {
        $message = $event->message;

        // Envoyer notification uniquement si c'est une notification et qu'elle est active
        if ($message->type === 'notification' && $message->active) {
            Log::info('üì§ Envoi de notification push pour le message', [
                'message_id' => $message->id,
                'titre' => $message->titre,
                'type' => $message->type,
            ]);

            try {
                $result = $this->notificationService->sendMessageNotificationToAll($message);
                
                Log::info('‚úÖ R√©sultat de l\'envoi de notification', [
                    'success' => $result,
                    'message_id' => $message->id,
                ]);
            } catch (\Exception $e) {
                Log::error('‚ùå Erreur lors de l\'envoi de notification', [
                    'message_id' => $message->id,
                    'error' => $e->getMessage(),
                ]);
            }
        }
    }
}
```

---

### 3. **M√©thode dans `NotificationService`**

Ajouter cette m√©thode dans : `app/Services/NotificationService.php`

```php
/**
 * Envoyer une notification de message √† tous les utilisateurs mobiles
 */
public function sendMessageNotificationToAll($message)
{
    try {
        // R√©cup√©rer tous les tokens FCM des utilisateurs mobiles actifs
        $fcmTokens = \App\Models\FcmToken::where('device_type', 'mobile')
            ->where('active', true)
            ->pluck('token')
            ->toArray();

        if (empty($fcmTokens)) {
            Log::warning('‚ö†Ô∏è Aucun token FCM mobile trouv√© pour l\'envoi de notification');
            return false;
        }

        Log::info('üì± Envoi de notification √† ' . count($fcmTokens) . ' appareils mobiles');

        // Pr√©parer le payload de notification
        $notification = [
            'title' => $message->titre,
            'body' => $message->contenu,
        ];

        $data = [
            'type' => 'message',
            'message_id' => (string) $message->id,
            'message_type' => $message->type,
            'click_action' => 'FLUTTER_NOTIFICATION_CLICK',
        ];

        // Envoyer la notification √† tous les tokens
        $successCount = 0;
        $failureCount = 0;

        // Envoyer par lots de 500 tokens (limite Firebase)
        $tokenChunks = array_chunk($fcmTokens, 500);

        foreach ($tokenChunks as $chunk) {
            try {
                $result = $this->sendToMultipleDevices($chunk, $notification, $data);
                
                if ($result) {
                    $successCount += count($chunk);
                } else {
                    $failureCount += count($chunk);
                }
            } catch (\Exception $e) {
                Log::error('‚ùå Erreur lors de l\'envoi √† un lot de tokens', [
                    'error' => $e->getMessage(),
                    'chunk_size' => count($chunk),
                ]);
                $failureCount += count($chunk);
            }
        }

        Log::info('üìä R√©sultat de l\'envoi de notifications', [
            'total' => count($fcmTokens),
            'success' => $successCount,
            'failure' => $failureCount,
        ]);

        return $successCount > 0;

    } catch (\Exception $e) {
        Log::error('‚ùå Erreur dans sendMessageNotificationToAll', [
            'error' => $e->getMessage(),
            'trace' => $e->getTraceAsString(),
        ]);
        return false;
    }
}

/**
 * Envoyer une notification √† plusieurs appareils
 */
private function sendToMultipleDevices(array $tokens, array $notification, array $data)
{
    try {
        $messaging = app('firebase.messaging');

        $message = [
            'notification' => $notification,
            'data' => $data,
            'android' => [
                'priority' => 'high',
                'notification' => [
                    'sound' => 'default',
                    'channel_id' => 'art_luxury_bus_channel',
                ],
            ],
            'apns' => [
                'payload' => [
                    'aps' => [
                        'sound' => 'default',
                        'badge' => 1,
                    ],
                ],
            ],
        ];

        // Envoyer √† tous les tokens
        $response = $messaging->sendMulticast($message, $tokens);

        Log::info('‚úÖ Notification multicast envoy√©e', [
            'success_count' => $response->successes()->count(),
            'failure_count' => $response->failures()->count(),
        ]);

        return $response->successes()->count() > 0;

    } catch (\Exception $e) {
        Log::error('‚ùå Erreur sendToMultipleDevices', [
            'error' => $e->getMessage(),
        ]);
        return false;
    }
}
```

---

### 4. **Enregistrer l'√©v√©nement et le listener**

Dans le fichier : `app/Providers/EventServiceProvider.php`

```php
<?php

namespace App\Providers;

use Illuminate\Foundation\Support\Providers\EventServiceProvider as ServiceProvider;
use App\Events\MessageCreated;
use App\Listeners\SendMessageNotification;

class EventServiceProvider extends ServiceProvider
{
    /**
     * The event listener mappings for the application.
     *
     * @var array<class-string, array<int, class-string>>
     */
    protected $listen = [
        // ... autres √©v√©nements existants

        MessageCreated::class => [
            SendMessageNotification::class,
        ],
    ];

    /**
     * Register any events for your application.
     */
    public function boot(): void
    {
        //
    }
}
```

---

### 5. **D√©clencher l'√©v√©nement lors de la cr√©ation d'un message**

Dans le contr√¥leur qui cr√©e les messages (probablement `app/Http/Controllers/Api/MessageController.php`), ajouter :

```php
use App\Events\MessageCreated;

public function store(Request $request)
{
    // Validation...
    
    $message = Message::create([
        'titre' => $request->titre,
        'contenu' => $request->contenu,
        'type' => $request->type,
        'gare_id' => $request->gare_id,
        'appareil' => $request->appareil,
        'date_debut' => $request->date_debut,
        'date_fin' => $request->date_fin,
        'active' => $request->active ?? true,
    ]);

    // üî• D√âCLENCHER L'√âV√âNEMENT
    event(new MessageCreated($message));

    return response()->json([
        'success' => true,
        'message' => 'Message cr√©√© avec succ√®s',
        'data' => $message,
    ], 201);
}
```

---

## üîß V√©rification de la configuration Firebase

Assurez-vous que le fichier de credentials Firebase est bien configur√© dans `config/services.php` :

```php
'firebase' => [
    'credentials' => storage_path('app/artluxurybus-d7a63-firebase-adminsdk-fbsvc-2adea67816.json'),
    'database_url' => env('FIREBASE_DATABASE_URL'),
],
```

---

## üìä V√©rifier que la table `fcm_tokens` existe

La table doit avoir cette structure :

```sql
CREATE TABLE `fcm_tokens` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `user_id` bigint unsigned NOT NULL,
  `token` text NOT NULL,
  `device_type` varchar(50) DEFAULT 'android',
  `device_id` varchar(255) DEFAULT NULL,
  `active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `fcm_tokens_user_id_foreign` (`user_id`),
  CONSTRAINT `fcm_tokens_user_id_foreign` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
);
```

---

## üß™ Tester l'impl√©mentation

### 1. Cr√©er un message de test via l'API

```bash
curl -X POST https://artluxurybus.ci/api/messages \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "titre": "Test Notification",
    "contenu": "Ceci est un test de notification pour tous les utilisateurs",
    "type": "notification",
    "appareil": "mobile",
    "active": true
  }'
```

### 2. V√©rifier les logs Laravel

```bash
tail -f storage/logs/laravel.log
```

Vous devriez voir :
```
[2025-10-23 12:00:00] üì§ Envoi de notification push pour le message
[2025-10-23 12:00:00] üì± Envoi de notification √† X appareils mobiles
[2025-10-23 12:00:00] ‚úÖ Notification multicast envoy√©e
[2025-10-23 12:00:00] üìä R√©sultat de l'envoi de notifications
```

### 3. V√©rifier sur l'app mobile

L'app devrait recevoir la notification automatiquement (m√™me en arri√®re-plan).

---

## üéØ R√©sum√© des √©tapes

1. ‚úÖ Cr√©er l'√©v√©nement `MessageCreated`
2. ‚úÖ Cr√©er le listener `SendMessageNotification`
3. ‚úÖ Ajouter la m√©thode `sendMessageNotificationToAll` dans `NotificationService`
4. ‚úÖ Enregistrer l'√©v√©nement dans `EventServiceProvider`
5. ‚úÖ D√©clencher l'√©v√©nement dans le contr√¥leur de cr√©ation de messages
6. ‚úÖ Tester la cr√©ation d'un message
7. ‚úÖ V√©rifier que les notifications sont re√ßues sur mobile

---

## üîç Debugging

Si les notifications ne sont toujours pas re√ßues :

### V√©rifier les tokens FCM en base de donn√©es

```sql
SELECT COUNT(*) as total_tokens, device_type 
FROM fcm_tokens 
WHERE active = 1 
GROUP BY device_type;
```

### V√©rifier les logs Firebase

Dans la console Firebase : **Cloud Messaging > Rapports**

### Tester manuellement depuis Firebase Console

1. Aller dans **Cloud Messaging > Send test message**
2. Coller un token FCM depuis la base de donn√©es
3. Envoyer un message de test
4. Si √ßa fonctionne, le probl√®me est dans le code Laravel
5. Si √ßa ne fonctionne pas, le probl√®me est dans la configuration Firebase/App

---

## ‚úÖ R√©sultat attendu

Une fois impl√©ment√© :

- ‚úÖ Chaque fois qu'un message de type "notification" est cr√©√©, une notification push est envoy√©e √† **tous les utilisateurs mobiles**
- ‚úÖ Les notifications apparaissent m√™me si l'app est ferm√©e
- ‚úÖ Les utilisateurs peuvent cliquer sur la notification pour ouvrir l'app
- ‚úÖ Les logs Laravel montrent le nombre de notifications envoy√©es avec succ√®s

---

## üìû Support

Si vous avez besoin d'aide pour impl√©menter ces changements c√¥t√© Laravel, v√©rifiez :

1. Que le package `kreait/firebase-php` est install√©
2. Que le fichier de credentials Firebase existe et est accessible
3. Que la table `fcm_tokens` contient des tokens actifs
4. Les logs Laravel pour voir les erreurs √©ventuelles

Bonne impl√©mentation ! üöÄ
